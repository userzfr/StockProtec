<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion de stock - Protection Civile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { padding: 20px; }
    .alerte { background-color: #ffdddd !important; }
    .critique, .expir√© {
      background-color: #f8d7da !important;
      animation: clignote 1s infinite alternate;
    }
    .code-barre-img svg { max-width: 100%; height: 50px; }
    .code-barre-img { max-width: 200px; word-break: break-all; }
    @keyframes clignote {
      from { background-color: #f8d7da; }
      to { background-color: #f1b0b7; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">üì¶ Gestion de Stock - Protection Civile</h1>
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-success" onclick="ajouterProduit()">‚ûï Ajouter un produit</button>
      <button class="btn btn-primary" onclick="exporterDonnees()">üíæ Exporter les donn√©es</button>
      <label class="btn btn-secondary">
        üìÅ Importer JSON <input type="file" id="importFile" accept=".json" onchange="importerDonnees()" hidden>
      </label>
      <label class="btn btn-secondary">
        üìä Importer Excel <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="importerExcel()" hidden>
      </label>
      <input id="searchInput" class="form-control w-auto" type="text" placeholder="üîé Recherche code-barres" oninput="rafraichirTableau()" />
    </div>

    <div id="notification" class="notification"></div>

    <table class="table table-bordered table-striped" id="stockTable">
      <thead class="table-dark">
        <tr>
          <th>Code-barres</th>
          <th>Nom</th>
          <th>Lot</th>
          <th>Date P√©remption</th>
          <th>Date Contr√¥le [ID]</th>
          <th>Quantit√©</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer class="text-center mt-5 text-muted">
    <hr>
    <p>Fait avec ‚ù§Ô∏è par Mathieu.M</p>
  </footer>

  <script>
    let stock = JSON.parse(localStorage.getItem("stock") || "[]");

    function enregistrerStock() {
      localStorage.setItem("stock", JSON.stringify(stock));
    }

    function genererCodeUnique() {
      return 'INV-' + Math.floor(100000 + Math.random() * 900000);
    }

    function genererIdControle() {
      const date = new Date();
      return "CTRL-" + date.toISOString().replace(/[-:.TZ]/g, "").slice(0, 14);
    }

    function afficherCodeBarreSvg(code) {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      JsBarcode(svg, code, { format: "CODE128", width: 2, height: 30, displayValue: false });
      return svg.outerHTML;
    }

    function ajouterProduit() {
      let code = prompt("Code-barres unique (laisser vide pour g√©n√©rer automatiquement) :");
      if (!code) {
        code = genererCodeUnique();
        alert("Code g√©n√©r√© automatiquement : " + code);
      }
      const nom = prompt("Nom du produit :");
      const lot = prompt("Num√©ro de lot :");
      const peremption = prompt("Date de p√©remption (YYYY-MM-DD) ou vide :");
      const quantite = parseInt(prompt("Quantit√© :")) || 0;
      const controle = new Date().toISOString().split("T")[0];
      const idControle = genererIdControle();

      const existant = stock.find(p => p.code === code);
      if (existant) {
        existant.quantite += quantite;
        existant.controle = controle;
        existant.idControle = idControle;
      } else {
        stock.push({ code, nom, lot, peremption, controle, idControle, quantite });
      }
      enregistrerStock();
      rafraichirTableau();
      afficherNotification(`Produit ajout√© avec ID de contr√¥le [${idControle}]`, "success", 0);
    }

    function rafraichirTableau() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const tbody = document.querySelector("#stockTable tbody");
      tbody.innerHTML = "";
      const now = new Date();

      stock.forEach((item, index) => {
        if (search && !item.code.toLowerCase().includes(search)) return;

        const tr = document.createElement("tr");
        let className = "";
        const datePeremption = item.peremption ? new Date(item.peremption) : null;
        const dateControle = item.controle ? new Date(item.controle) : null;

        if (!dateControle || daysBetween(dateControle, now) > 30 || (datePeremption && datePeremption < now)) {
          className = "critique";
        } else if (datePeremption && daysBetween(now, datePeremption) < 30) {
          className = "expir√©";
        } else if (item.quantite <= 1) {
          className = "alerte";
        }

        tr.className = className;
        tr.id = `row-${item.code}`;

        const svgCode = afficherCodeBarreSvg(item.code);

        tr.innerHTML = `
          <td><div class="code-barre-img">${svgCode}<div class="small">${item.code}</div></div></td>
          <td>${item.nom}</td>
          <td>${item.lot}</td>
          <td>${item.peremption || '-'}</td>
          <td>${item.controle || '-'}<br><span class="text-muted small">[${item.idControle || '-'}]</span></td>
          <td>${item.quantite}</td>
          <td>
            <button class="btn btn-sm btn-secondary me-1" onclick="modifierProduit(${index})">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-info me-1" onclick="controlerProduit(${index})">üïµÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="supprimer(${index})">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      notificationAutomatique();
    }

    function modifierProduit(index) {
      const p = stock[index];
      const nom = prompt("Nom :", p.nom);
      const lot = prompt("Lot :", p.lot);
      const peremption = prompt("P√©remption (YYYY-MM-DD) :", p.peremption);
      const quantite = prompt("Quantit√© :", p.quantite);

      if (nom) p.nom = nom;
      if (lot) p.lot = lot;
      if (peremption) p.peremption = peremption;
      if (quantite) p.quantite = parseInt(quantite) || p.quantite;

      enregistrerStock();
      rafraichirTableau();
      afficherNotification("Produit modifi√©.", "success", 0);
    }

    function controlerProduit(index) {
      const now = new Date();
      stock[index].controle = now.toISOString().split("T")[0];
      stock[index].idControle = genererIdControle();
      enregistrerStock();
      rafraichirTableau();
      afficherNotification(`Contr√¥le enregistr√©. [${stock[index].idControle}]`, "info", 0);
    }

    function supprimer(index) {
      if (confirm("Supprimer ce produit ?")) {
        stock.splice(index, 1);
        enregistrerStock();
        rafraichirTableau();
        afficherNotification("Produit supprim√©.", "danger", 0);
      }
    }

    function daysBetween(d1, d2) {
      return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
    }

    function notificationAutomatique() {
      const now = new Date();
      let perimes = 0;
      let controles = 0;

      stock.forEach((item) => {
        const peremption = item.peremption ? new Date(item.peremption) : null;
        const controle = item.controle ? new Date(item.controle) : null;
        if (peremption && peremption < now) perimes++;
        if (!controle || daysBetween(controle, now) > 30) controles++;
      });

      if (perimes > 0 || controles > 0) {
        afficherNotification(`‚ö†Ô∏è ${perimes} produit(s) p√©rim√©(s), ${controles} en attente de v√©rification !`, "danger", 0);
      } else {
        afficherNotification("‚úÖ Tous les stocks sont √† jour et sans risque de p√©remption.", "success", 0);
      }
    }

    function afficherNotification(message, type = "success", duree = 0) {
      const div = document.getElementById("notification");
      div.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
      if (duree > 0) {
        setTimeout(() => div.innerHTML = "", duree);
      }
    }

    rafraichirTableau();
  </script>
</body>
</html>
