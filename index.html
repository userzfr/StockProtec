<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion de stock - Protection Civile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { padding: 20px; }
    .alerte { background-color: #ffdddd !important; }
    .critique, .expiré { animation: clignote 1s infinite alternate; }
    .critique { background-color: #f8d7da !important; }
    .expiré { background-color: #fff3cd !important; }
    .code-barre-img svg { max-width: 100%; height: 50px; }
    .code-barre-img { max-width: 200px; word-break: break-word; }
    @keyframes clignote {
      from { background-color: #f8d7da; }
      to { background-color: #f1b0b7; }
    }
    #btnDanger { animation: clignote 1s infinite alternate; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">📦 Gestion de Stock - Protection Civile</h1>
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-danger d-none" id="btnDanger" onclick="scrollToAlert()">🚨 Attention stock à risque</button>
      <button class="btn btn-success" onclick="ajouterProduit()">➕ Ajouter un produit</button>
      <button class="btn btn-primary" onclick="exporterDonnees()">💾 Exporter les données</button>
      <label class="btn btn-secondary">
        📁 Importer JSON <input type="file" id="importFile" accept=".json" onchange="importerDonnees()" hidden>
      </label>
      <label class="btn btn-secondary">
        📊 Importer Excel <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="importerExcel()" hidden>
      </label>
      <input id="searchInput" class="form-control w-auto" type="text" placeholder="🔎 Recherche code-barres" oninput="rafraichirTableau()" />
    </div>

    <div id="notification" class="notification"></div>

    <table class="table table-bordered table-striped" id="stockTable">
      <thead class="table-dark">
        <tr>
          <th>Code-barres</th>
          <th>Nom</th>
          <th>Lot</th>
          <th>Date Péremption</th>
          <th>Date Contrôle</th>
          <th>Quantité</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer class="text-center mt-5 text-muted">
    <hr>
    <p>Fait avec ❤️ par Mathieu.M</p>
  </footer>

  <script>
    let stock = JSON.parse(localStorage.getItem("stock") || "[]");

    function enregistrerStock() {
      localStorage.setItem("stock", JSON.stringify(stock));
    }

    function genererCodeUnique() {
      const timestamp = new Date().toISOString().replace(/[-:.TZ]/g, "").slice(0, 14);
      return "INV-" + timestamp + "-" + Math.floor(1000 + Math.random() * 9000);
    }

    function afficherCodeBarreSvg(code) {
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      JsBarcode(svg, code, { format: "CODE128", width: 2, height: 30, displayValue: false });
      return svg.outerHTML;
    }

    function ajouterProduit() {
      let code = prompt("Code-barres unique (laisser vide pour générer automatiquement) :");
      if (!code) {
        code = genererCodeUnique();
        alert("Code généré automatiquement : " + code);
      }
      const nom = prompt("Nom du produit :");
      const lot = prompt("Numéro de lot :");
      const peremption = prompt("Date de péremption (YYYY-MM-DD) ou vide :");
      const quantite = parseInt(prompt("Quantité :")) || 0;
      const controle = new Date().toISOString().split("T")[0];
      const idControle = "CTRL-" + new Date().toISOString().replace(/[-:.TZ]/g, "").slice(0, 14);

      const existant = stock.find(p => p.code === code);
      if (existant) {
        existant.quantite += quantite;
        existant.controle = controle;
        existant.idControle = idControle;
      } else {
        stock.push({ code, nom, lot, peremption, controle, idControle, quantite });
      }
      enregistrerStock();
      rafraichirTableau();
      afficherNotification("Produit ajouté/modifié avec succès.");
    }

    function rafraichirTableau() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const tbody = document.querySelector("#stockTable tbody");
      tbody.innerHTML = "";
      const now = new Date();
      let danger = false;

      stock.forEach((item, index) => {
        if (search && !item.code.toLowerCase().includes(search)) return;

        const tr = document.createElement("tr");
        let className = "";
        const datePeremption = item.peremption ? new Date(item.peremption) : null;
        const dateControle = item.controle ? new Date(item.controle) : null;
        const joursPeremption = datePeremption ? daysBetween(now, datePeremption) : Infinity;
        const joursControle = dateControle ? daysBetween(dateControle, now) : Infinity;

        if (!dateControle || joursControle > 30 || (datePeremption && joursPeremption < 0)) {
          className = "critique";
          danger = true;
        } else if (joursPeremption >= 0 && joursPeremption < 30) {
          className = "expiré";
          danger = true;
        } else if (item.quantite <= 1) {
          className = "alerte";
        }

        tr.className = className;
        tr.id = `row-${item.code}`;

        const svgCode = afficherCodeBarreSvg(item.code);

        tr.innerHTML = `
          <td><div class="code-barre-img">${svgCode}<div class="small">${item.code}</div></div></td>
          <td>${item.nom}</td>
          <td>${item.lot}</td>
          <td>${item.peremption || '-'}</td>
          <td>${item.controle || '-'}<br><span class="text-muted small">[${item.idControle || '-'}]</span></td>
          <td>${item.quantite}</td>
          <td>
            <button class="btn btn-sm btn-secondary me-1" onclick="modifierProduit(${index})">✏️</button>
            <button class="btn btn-sm btn-info me-1" onclick="controlerProduit(${index})">🕵️</button>
            <button class="btn btn-sm btn-danger" onclick="supprimer(${index})">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      const dangerBtn = document.getElementById("btnDanger");
      if (danger) {
        dangerBtn.classList.remove("d-none");
      } else {
        dangerBtn.classList.add("d-none");
      }

      notificationAutomatique();
    }

    function modifierProduit(index) {
      const produit = stock[index];
      const nom = prompt("Nom :", produit.nom);
      if (nom) produit.nom = nom;
      const lot = prompt("Lot :", produit.lot);
      if (lot) produit.lot = lot;
      const peremption = prompt("Péremption (YYYY-MM-DD) :", produit.peremption);
      if (peremption) produit.peremption = peremption;
      const quantite = prompt("Quantité :", produit.quantite);
      if (quantite !== null && quantite !== "") produit.quantite = parseInt(quantite) || 0;
      enregistrerStock();
      rafraichirTableau();
      afficherNotification("Produit modifié.");
    }

    function controlerProduit(index) {
      stock[index].controle = new Date().toISOString().split("T")[0];
      stock[index].idControle = "CTRL-" + new Date().toISOString().replace(/[-:.TZ]/g, "").slice(0, 14);
      enregistrerStock();
      rafraichirTableau();
      afficherNotification("Produit contrôlé.");
    }

    function daysBetween(date1, date2) {
      return Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
    }

    function exporterDonnees() {
      const dataStr = JSON.stringify(stock, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "stock_data.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importerDonnees() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (Array.isArray(importedData)) {
            stock = importedData;
            enregistrerStock();
            rafraichirTableau();
            afficherNotification("Données importées avec succès.");
          } else {
            throw new Error("Format de fichier invalide.");
          }
        } catch (error) {
          alert("Erreur lors de l'importation : " + error.message);
        }
      };
      reader.readAsText(file);
    }

    function importerExcel() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        jsonData.forEach(row => {
          const existant = stock.find(p => p.code === row["Code-barres"]);
          if (existant) {
            existant.quantite += parseInt(row["Quantité"]) || 0;
            existant.controle = new Date().toISOString().split("T")[0];
          } else {
            stock.push({
              code: row["Code-barres"],
              nom: row["Nom"],
              lot: row["Lot"],
              peremption: row["Péremption"],
              controle: new Date().toISOString().split("T")[0],
              quantite: parseInt(row["Quantité"]) || 0
            });
          }
        });

        enregistrerStock();
        rafraichirTableau();
        afficherNotification("Données Excel importées avec succès.");
      };
      reader.readAsArrayBuffer(file);
    }

    function notificationAutomatique() {
      const now = new Date();
      let perimes = 0;
      let controles = 0;

      stock.forEach((item) => {
        const datePeremption = item.peremption ? new Date(item.peremption) : null;
        const dateControle = item.controle ? new Date(item.controle) : null;

        if (datePeremption && datePeremption < now) perimes++;
        if (!dateControle || daysBetween(dateControle, now) > 30) controles++;
      });

      if (perimes > 0 || controles > 0) {
        afficherNotification(`⚠️ ${perimes} produit(s) périmé(s), ${controles} en attente de vérification !`, "danger", 0);
      } else {
        afficherNotification("✅ Tous les stocks sont à jour et sans risque de péremption.", "success", 0);
      }
    }

    function afficherNotification(message, type = "success", duree = 0) {
      const div = document.getElementById("notification");
      div.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
      if (duree > 0) setTimeout(() => div.innerHTML = "", duree);
    }

    function scrollToAlert() {
      const first = document.querySelector("tr.critique, tr.expiré");
      if (first) {
        first.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }

    rafraichirTableau();
  </script>
</body>
</html>